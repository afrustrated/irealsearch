<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jazz Standard Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Music&family=Noto+Sans:wght@700&display=swap" rel="stylesheet">
    <style>
        .sheet-music-container {
            font-family: 'Segoe UI', sans-serif;
            background-color: #fff;
            color: #1a1a1a;
        }

        /* ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ: í…Œë‘ë¦¬ ì—†ì´ ì•…ë³´ì²˜ëŸ¼ ë°°ì¹˜ */
        .grid-chart {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            width: 100%;
            row-gap: 2rem; /* ì¤„ ê°„ê²© ë„‰ë„‰í•˜ê²Œ */
        }

        /* ê°œë³„ ë§ˆë”” ì…€ */
        .bar-cell {
            position: relative;
            min-height: 80px; /* ë†’ì´ ì¤„ì„ */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.2rem;
            text-align: center;
            border-right: 1.5px solid #1a1a1a; /* ê¸°ë³¸ ì„¸ë¡œì¤„ */
        }
        
        /* 4ë²ˆì§¸ ë§ˆë””ëŠ” ì„¸ë¡œì¤„ ì œê±° (ì¤„ë°”ê¿ˆ íš¨ê³¼) */
        .bar-cell:nth-child(4n) {
            border-right: none;
        }

        /* [ì¶”ê°€] ê²¹ì„¸ë¡œì¤„ ìŠ¤íƒ€ì¼ (JSì—ì„œ í´ë˜ìŠ¤ ì¶”ê°€) */
        .bar-double-right {
            border-right: 4px double #1a1a1a !important;
        }
        .bar-start { /* ì¤„ ì‹œì‘ì  ê°•ì¡° */
            border-left: 1.5px solid #1a1a1a;
        }

        /* ì½”ë“œ í…ìŠ¤íŠ¸ (ë°˜ì‘í˜• í°íŠ¸) */
        .chord-text {
            font-family: 'Verdana', sans-serif;
            font-weight: 700;
            color: #1e3a8a;
            /* í™”ë©´ ë„ˆë¹„ì— ë”°ë¼ í°íŠ¸ í¬ê¸° ìë™ ì¡°ì ˆ (ìµœì†Œ 14px ~ ìµœëŒ€ 28px) */
            font-size: clamp(14px, 2.5vw, 28px); 
            line-height: 1.1;
        }

        /* ë°˜ë³µ ê¸°í˜¸ (%) ìŠ¤íƒ€ì¼ */
        .repeat-sign {
            font-family: 'Times New Roman', serif;
            font-size: clamp(20px, 4vw, 40px);
            font-weight: bold;
            color: #374151;
        }

        /* ì•…ìƒ ê¸°í˜¸ (ì„¸ë‡¨, ì½”ë‹¤) - SVGë¡œ ëŒ€ì²´í•˜ì—¬ ê¹¨ì§ ë°©ì§€ */
        .musical-symbol {
            position: absolute;
            top: -22px; 
            width: 20px;
            height: 20px;
        }
        .symbol-coda { right: -10px; z-index: 10; } /* ë§ˆë”” ëì— ê±¸ì¹˜ê²Œ */
        .symbol-segno { left: 0px; }

        /* ì§€ì‹œì–´ (D.C. al Coda) */
        .instruction-text {
            position: absolute;
            top: -18px;
            right: 0;
            font-size: 0.75rem;
            font-weight: bold;
            color: #1a1a1a;
            font-style: italic;
            white-space: nowrap;
        }

        /* ì„¹ì…˜ ë§ˆì»¤ (A, B) */
        .section-marker {
            position: absolute;
            top: -24px;
            left: -2px;
            background-color: #dc2626;
            color: #fff;
            font-size: 0.8rem;
            font-weight: 900;
            padding: 0px 6px;
            border-radius: 2px;
        }

        .time-sig {
            position: absolute;
            top: 2px;
            left: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            color: #64748b;
        }

        .highlight {
            background-color: #fde047;
            padding: 2px;
            border-radius: 4px;
        }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; opacity: 0; transition: opacity 0.3s; }
        .modal.active { display: flex; opacity: 1; }
        .btn-submitting { opacity: 0.5; cursor: not-allowed; pointer-events: none; background-color: #64748b !important; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4">

<div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-3xl p-6 md:p-10">
    <h1 class="text-3xl font-black text-indigo-700 text-center mb-6">ğŸ· Jazz Archive Search</h1>

    <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200 mb-8 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ì œëª©/ì‘ê³¡ê°€</label>
                <input type="text" id="titleInput" placeholder="ê³¡ ì œëª©..." class="w-full p-3 rounded-xl border border-slate-300 outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ê²€ìƒ‰ ëª¨ë“œ</label>
                <select id="searchMode" class="w-full p-3 rounded-xl border border-slate-300 bg-white">
                    <option value="relative" selected>ìƒëŒ€ì  ì¸í„°ë²Œ (Relative Interval)</option>
                    <option value="harmonic">í™”ì„±ì  ê¸°ëŠ¥ (Harmonic Function)</option>
                    <option value="absolute">ì‹¤ìŒ ì½”ë“œ (Real Note)</option>
                </select>
            </div>
        </div>
        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ì½”ë“œ ì§„í–‰ (ì˜ˆ: Am7 D7 Gmaj7)</label>
            <div class="flex gap-2">
                <input type="text" id="chordInput" placeholder="ì½”ë“œ ì…ë ¥..." class="flex-1 p-3 rounded-xl border border-slate-300 outline-none focus:ring-2 focus:ring-indigo-500">
                <select id="keySelect" class="p-3 rounded-xl border border-slate-300 bg-white hidden">
                    <option value="C">C</option><option value="Db">Db</option><option value="D">D</option><option value="Eb">Eb</option><option value="E">E</option><option value="F">F</option><option value="Gb">Gb</option><option value="G">G</option><option value="Ab">Ab</option><option value="A">A</option><option value="Bb">Bb</option><option value="B">B</option>
                </select>
                <button onclick="performSearch()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 transition">ê²€ìƒ‰</button>
            </div>
        </div>
    </div>

    <div id="status" class="text-sm text-center text-slate-400 mb-4 italic">ë°ì´í„° ë¡œë“œ ì¤‘...</div>
    <div id="results" class="grid grid-cols-1 gap-2"></div>
</div>

<div id="detailModal" class="modal items-center justify-center">
    <div class="bg-white w-full max-w-3xl m-2 p-6 rounded-sm shadow-2xl relative max-h-[95vh] overflow-y-auto sheet-music-container">
        <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-black text-3xl transition">âœ•</button>
        
        <div class="border-b-2 border-black pb-4 mb-4 text-center relative mt-4">
            <div id="mStyle" class="absolute left-0 top-1 text-xs font-bold uppercase text-slate-500 tracking-widest hidden md:block"></div>
            <h2 id="mTitle" class="text-2xl md:text-4xl font-serif font-bold tracking-tight uppercase"></h2>
            <div id="mComposer" class="absolute right-0 top-1 text-sm font-medium italic hidden md:block"></div>
        </div>

        <div class="flex justify-between items-end mb-4 px-1">
            <div class="text-sm text-slate-500">Original Key: <span id="mOriginalKey" class="font-bold text-black"></span></div>
            <div class="flex flex-col items-end">
                <label class="text-[10px] font-bold text-slate-400 uppercase">TRANSPOSE</label>
                <select id="transposeSelect" onchange="updateModalDisplay()" class="text-lg font-bold border-b-2 border-black bg-transparent outline-none cursor-pointer"></select>
            </div>
        </div>

        <div id="mChords" class="grid-chart mb-8"></div>

        <div class="mt-8 pt-6 border-t border-slate-100">
            <h3 class="text-lg font-black mb-4 flex items-center gap-2 text-slate-800">ğŸ¥ Recommended Performances</h3>
            <ul id="linkList" class="grid grid-cols-1 gap-2 mb-6"></ul>
            
            <div class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">Add Performance Link</h4>
                
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input id="inPerformer" type="text" placeholder="ì—°ì£¼ì (Artist)" class="p-2 rounded border text-sm">
                    <input id="inYear" type="text" placeholder="ì—°ë„ (Year)" class="p-2 rounded border text-sm">
                </div>
                <div class="grid grid-cols-3 gap-2 mb-2">
                    <input id="inRecommender" type="text" placeholder="ì¶”ì²œì¸ (Name)" class="col-span-1 p-2 rounded border text-sm">
                    <input id="inComment" type="text" placeholder="í•œì¤„í‰ (Comment)" class="col-span-2 p-2 rounded border text-sm">
                </div>
                
                <input id="inUrl" type="text" placeholder="YouTube URL" class="w-full p-2 rounded border text-sm mb-3">
                <button id="submitBtn" onclick="addLink()" class="w-full bg-slate-800 text-white py-2 rounded font-bold hover:bg-black transition">Submit Link</button>
            </div>
        </div>
    </div>
</div>

<script>
// ==========================================
// 1. ì„¤ì • ë° ì „ì—­ ë³€ìˆ˜
// ==========================================
const API_URL = "https://script.google.com/macros/s/AKfycbyKW8Ru9l1wbFqWEI70Nd8ZuBn8QR7YAVKTem1xY_tyIG8JkzifEUn0-4ndFvbxr1FSsg/exec";
let songDatabase = [];
let currentOpenedSong = null;
let isSubmitting = false;

const allKeys = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
const noteMap = {'C':0,'B#':0,'Db':1,'C#':1,'D':2,'Eb':3,'D#':3,'E':4,'Fb':4,'F':5,'E#':5,'Gb':6,'F#':6,'G':7,'Ab':8,'G#':8,'A':9,'Bb':10,'A#':10,'B':11,'Cb':11};

// ==========================================
// 2. í™”ì„±í•™ ì—”ì§„
// ==========================================
function simplifyQuality(q) {
    q = q.trim().replace(/\^/g, "maj").replace(/min/g, "m").replace(/Min/g, "m");
    if (q.includes("m7b5") || q.includes("h") || q.includes("Ã¸")) return "HALF_DIM";
    if (q.includes("dim") || q.includes("o") || q.includes("Â°")) return "DIM";
    if (/[79]|11|13|alt/.test(q)) {
        let isMinor = q.includes("m") || (q.includes("-") && !q.includes("7-"));
        let isMajor = q.includes("maj") || q.includes("M");
        if (!isMinor && !isMajor) return "DOMINANT";
        if (q.includes("7-")) return "DOMINANT";
    }
    if (q.includes("m") || q.includes("-")) return "MINOR";
    if (q === "" || q === "6" || q.includes("maj") || q.includes("M")) return "MAJOR";
    return "DOMINANT";
}

function parseChord(str) {
    if (!str) return null;
    let [main, bass] = str.split('/');
    let match = main.match(/^([A-G][b#]?)(.*)/);
    if (!match) return null;
    return { root: match[1], quality: simplifyQuality(match[2]), bass: bass || match[1] };
}

function getDistance(n1, n2) {
    const r1 = n1.replace('-', '').trim();
    const r2 = n2.replace('-', '').trim();
    if (!(r1 in noteMap) || !(r2 in noteMap)) return 0;
    return (noteMap[r2] - noteMap[r1] + 12) % 12;
}

function transposeChord(chord, steps) {
    return chord.replace(/([A-G][b#]?)/g, (match) => {
        const idx = allKeys.indexOf(match.replace('C#','Db').replace('D#','Eb').replace('F#','Gb').replace('G#','Ab').replace('A#','Bb').replace('B#','C').replace('Cb','B'));
        if (idx === -1) return match;
        const newIdx = (idx + steps + 12) % 12;
        return allKeys[newIdx];
    });
}

// ==========================================
// 3. íŒì—… ìœˆë„ìš° ìƒì„± (í™”ë©´ ë§ì¶¤í˜•)
// ==========================================
function openChartWindow() {
    if (!currentOpenedSong) return;
    
    const targetKey = document.getElementById('transposeSelect').value;
    const originalKey = currentOpenedSong.key.replace('-', '');
    const steps = (allKeys.indexOf(targetKey) - allKeys.indexOf(originalKey) + 12) % 12;
    
    // ì°¨íŠ¸ ë°ì´í„° ìƒì„± (ì—¬ê¸°ì„œ ì´ í–‰ ê°œìˆ˜ë¥¼ ê³„ì‚°)
    const { html: chartHtml, rowCount } = generateGridHtml(currentOpenedSong.display_chords, steps);
    
    // ìƒˆ ì°½ ì—´ê¸°
    const w = window.open("", "_blank", "width=1200,height=800");
    if (!w) return alert("íŒì—… ì°¨ë‹¨ì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. í•´ì œí•´ì£¼ì„¸ìš”.");

    w.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>${currentOpenedSong.title} - ${targetKey}</title>
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&family=Noto+Sans:wght@700&display=swap');
                
                body { 
                    margin: 0; padding: 1vh 2vw; 
                    font-family: 'Segoe UI', sans-serif; 
                    background: #fff; 
                    height: 100vh; 
                    overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
                    display: flex; flex-direction: column;
                    box-sizing: border-box;
                }
                
                header { 
                    flex-shrink: 0; 
                    text-align: center; 
                    border-bottom: 2px solid #000; 
                    padding-bottom: 1vh; margin-bottom: 1vh;
                    position: relative;
                }
                h1 { margin: 0; font-family: 'Times New Roman', serif; font-size: 5vh; text-transform: uppercase; line-height: 1; }
                .meta { font-size: 2vh; color: #555; font-weight: bold; display: flex; justify-content: space-between; position: absolute; width: 100%; top: 0; }
                
                /* ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ: í™”ë©´ ê½‰ ì±„ìš°ê¸° */
                .chart-container { 
                    flex: 1; 
                    display: grid; 
                    grid-template-columns: repeat(4, 1fr); 
                    /* í–‰ ë†’ì´ë¥¼ ê· ë“±í•˜ê²Œ ë¶„ë°°í•˜ì—¬ í™”ë©´ì— ê½‰ ì±„ì›€ */
                    grid-template-rows: repeat(${rowCount}, 1fr);
                    width: 100%; 
                    gap: 0; 
                }

                /* ë§ˆë”” ì…€ (ê¸°ë³¸ í…Œë‘ë¦¬ ì—†ìŒ, ìš°ì¸¡ ì„¸ë¡œì„ ë§Œ ì¡´ì¬) */
                .cell { 
                    position: relative; 
                    border-right: 2px solid #000; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    width: 100%;
                    height: 100%; /* ë¶€ëª¨(grid row) ë†’ì´ ë”°ë¼ê° */
                }
                
                /* 4ë²ˆì§¸ ë§ˆë”” ìš°ì¸¡ ì„  ì œê±° */
                .cell:nth-child(4n) { border-right: none; }
                
                /* [íŠ¹ìˆ˜ ë§ˆë””ì„  ìŠ¤íƒ€ì¼] */
                /* ì¤„ ì‹œì‘ ì™¼ìª½ ì„  */
                .row-start { border-left: 2px solid #000; }
                
                /* ê²¹ì„¸ë¡œì¤„ (||) */
                .double-bar { border-right: 6px double #000 !important; }
                
                /* ë„ëŒì´í‘œ ì‹œì‘ (|:) */
                .rep-start { border-left: 6px double #000 !important; }
                .rep-start::before { content: ':'; position: absolute; left: 4px; font-weight: bold; font-size: 3vh; font-family: serif; }
                
                /* ë„ëŒì´í‘œ ë (:|) */
                .rep-end { border-right: 6px double #000 !important; }
                .rep-end::after { content: ':'; position: absolute; right: 4px; font-weight: bold; font-size: 3vh; font-family: serif; }

                /* í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ (ë°˜ì‘í˜•) */
                .chord { 
                    font-family: 'Roboto Mono', monospace; 
                    /* ì¹¸ ë†’ì´ì— ë¹„ë¡€í•œ í°íŠ¸ ì‚¬ì´ì¦ˆ */
                    font-size: min(4vw, ${80 / rowCount}vh); 
                    color: #1e3a8a; 
                    font-weight: 700; 
                    letter-spacing: -0.05em;
                }
                .repeat-symbol { font-family: serif; font-size: min(6vw, ${100 / rowCount}vh); color: #444; }
                
                /* ì„¹ì…˜ ë§ˆì»¤ */
                .section { 
                    position: absolute; top: -1vh; left: -2px; 
                    background: #dc2626; color: white; 
                    font-size: 1.8vh; padding: 0.2vh 0.8vh; 
                    font-weight: bold; border-radius: 2px;
                    z-index: 5;
                }
                
                /* SVG ì•„ì´ì½˜ */
                .symbol-icon { position: absolute; top: 0; width: 3vh; height: 3vh; }
                .segno { left: 5px; }
                .coda { right: 5px; }

                /* D.C. al Coda */
                .instruction { 
                    position: absolute; bottom: 0; right: 0; 
                    font-size: 2vh; font-weight: bold; 
                    color: #000; text-align: right; 
                    white-space: nowrap;
                    background: rgba(255,255,255,0.8);
                }

                /* ë°•ìí‘œ (í•„ìš”ì‹œ) */
                .time-sig { position: absolute; top: 2px; left: 4px; font-size: 1.5vh; color: #888; font-style: italic; }

            </style>
        </head>
        <body>
            <header>
                <div class="meta">
                    <span>${currentOpenedSong.style || 'Jazz'}</span>
                    <span>${currentOpenedSong.composer}</span>
                </div>
                <h1>${currentOpenedSong.title}</h1>
                <div style="text-align: right; font-size: 1.5vh; margin-top: 0.5vh;">
                    Original: ${currentOpenedSong.key} | Transpose: <b>${targetKey}</b>
                </div>
            </header>
            <div class="chart-container">
                ${chartHtml}
            </div>
        </body>
        </html>
    `);
    w.document.close();
}

// ê·¸ë¦¬ë“œ ìƒì„± í•¨ìˆ˜ (ë¹ˆ ë§ˆë””/íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬ ê°•í™”)
function generateGridHtml(rawString, transposeSteps) {
    // 1. í† í°í™” ì „ì²˜ë¦¬ (Pythonì—ì„œ ë³€í™˜ëœ í† í°ë“¤ì„ í™œìš©)
    let text = rawString
        .replace(/\*([a-zA-Z])/g, "||SEC_$1||")
        .replace(/T(\d)(\d)/g, "||TIME_$1/$2||")
        .replace(/\|+/g, "|"); // ì¤‘ë³µ íŒŒì´í”„ ì œê±°

    let rawTokens = text.split('|').map(t => t.trim());
    // ì•ë’¤ ë¹ˆ í† í° ì œê±°
    if(rawTokens[0] === "") rawTokens.shift();
    if(rawTokens[rawTokens.length-1] === "") rawTokens.pop();
    
    let html = "";
    let barsCount = 0; // ì´ ë§ˆë”” ìˆ˜
    
    // ìƒíƒœ ë³€ìˆ˜ë“¤
    let currentSection = null;
    let nextBarType = "normal"; // normal, double, rep_start

    // SVG ì•„ì´ì½˜ ì •ì˜
    const SVG_SEGNO = `<svg viewBox="0 0 50 50" class="symbol-icon segno"><path d="M25 10 Q40 10 40 25 T25 40 Q10 40 10 25 T25 10 M15 35 L35 15 M20 20 L30 30" stroke="black" stroke-width="4" fill="none"/></svg>`;
    const SVG_CODA = `<svg viewBox="0 0 50 50" class="symbol-icon coda"><circle cx="25" cy="25" r="18" stroke="black" stroke-width="3" fill="none"/><line x1="25" y1="5" x2="25" y2="45" stroke="black" stroke-width="3"/><line x1="5" y1="25" x2="45" y2="25" stroke="black" stroke-width="3"/></svg>`;

    rawTokens.forEach(token => {
        if (!token) return;

        // ë©”íƒ€ ë°ì´í„° ì²˜ë¦¬ (í™”ë©´ì— ì•ˆ ê·¸ë¦¼)
        if (token.startsWith("SEC_")) { currentSection = token.split('_')[1]; return; }
        if (token.startsWith("TIME_")) { return; } // ë°•ìí‘œëŠ” ê³µê°„ ì ˆì•½ì„ ìœ„í•´ ìƒëµí•˜ê±°ë‚˜ í•„ìš”ì‹œ ì¶”ê°€

        // íŠ¹ìˆ˜ ë§ˆë””ì„  ì§€ì‹œì–´ ì²˜ë¦¬
        if (token === "DBL") { nextBarType = "double"; return; }
        if (token === "REP_START") { nextBarType = "rep_start"; return; }
        if (token === "RDBL") { return; } // ë‹«ëŠ” ê²¹ì„¸ë¡œì¤„ì€ í˜„ì¬ ë§ˆë”” ëë‚  ë•Œ ì²˜ë¦¬í•´ì•¼ í•¨ (ì•„ë˜ ë¡œì§ì—ì„œ ì²˜ë¦¬ ê³¤ë€í•˜ë¯€ë¡œ ì¼ë‹¨ ë¬´ì‹œí•˜ê±°ë‚˜ ë‹¤ìŒ ë§ˆë”” ì‹œì‘ìœ¼ë¡œ ë„˜ê¹€)
        if (token === "REP_END") { 
            // ë°”ë¡œ ì§ì „ ë§ˆë””(ì´ë¯¸ ì¶”ê°€ëœ HTML)ë¥¼ ìˆ˜ì •í•˜ê¸° ì–´ë ¤ìš°ë¯€ë¡œ, 
            // ì—¬ê¸°ì„œëŠ” 'REP_END'ê°€ ë‚˜ì˜¤ë©´ í˜„ì¬ ë§ˆë””(ì•„ì§ ì•ˆê·¸ë ¤ì§„)ê°€ ì•„ë‹ˆë¼ 'ì´ì „ ë§ˆë””ì˜ ë'ì´ì–´ì•¼ í•¨.
            // í•˜ì§€ë§Œ êµ¬ì¡°ìƒ í† í°ì´ ìˆœì„œëŒ€ë¡œ ì˜¤ë¯€ë¡œ, ì´ í† í°ì´ 'ì½”ë“œ' ë’¤ì— ì™”ë‹¤ë©´,
            // ì‚¬ì‹¤ìƒ ì´ í† í°ì€ 'í˜„ì¬ ë‹«íˆëŠ” ë§ˆë””'ì˜ ì†ì„±ì´ì–´ì•¼ í•¨.
            // ê°„ë‹¨í•˜ê²Œ: REP_END í† í°ì„ ë§Œë‚˜ë©´, html ë¬¸ìì—´ì˜ ë§ˆì§€ë§‰ '</div>' ì•ì— classë¥¼ ì¶”ê°€í•˜ëŠ” ë°©ì‹ì€ ë³µì¡í•¨.
            // ëŒ€ì•ˆ: REP_ENDëŠ” ë³´í†µ ë§ˆë”” ë’¤ì— ì˜´. 
            // JS ë¡œì§ì„ ë‹¨ìˆœí™”í•˜ê¸° ìœ„í•´, ë§ˆë””ë¥¼ ê·¸ë¦´ ë•Œ 'ë‹¤ìŒ í† í°'ì„ ë¯¸ë¦¬ ì—¿ë³´ëŠ”ê²Œ ì¢‹ìŒ.
            return; 
        }

        // --- ì‹¤ì œ ë§ˆë”” ë Œë”ë§ ---
        
        let barText = token;
        let symbols = "";
        let instruction = "";
        let classes = ["cell"];
        
        // 1. ë§ˆë”” ì™¼ìª½ ìŠ¤íƒ€ì¼ (ì‹œì‘ì„ )
        if (barsCount % 4 === 0) classes.push("row-start"); // ì¤„ ì‹œì‘
        
        if (nextBarType === "double") { classes.push("double-bar"); } // ê²¹ì„¸ë¡œì¤„ì€ ë³´í†µ ì˜¤ë¥¸ìª½ì´ì§€ë§Œ, ì‹œì‘ì ì´ë©´ ì™¼ìª½ì¼ ìˆ˜ë„ ìˆìŒ. ì—¬ê¸°ì„  ë‹¨ìˆœí™”.
        if (nextBarType === "rep_start") { classes.push("rep-start"); }
        
        nextBarType = "normal"; // ë¦¬ì…‹

        // 2. ë§ˆë”” ì˜¤ë¥¸ìª½ ìŠ¤íƒ€ì¼ (ë„ëŒì´í‘œ ë ë“±)
        // í˜„ì¬ í† í° ë’¤ì— REP_ENDê°€ ìˆëŠ”ì§€ í™•ì¸
        let nextTokenIdx = rawTokens.indexOf(token) + 1;
        if (rawTokens[nextTokenIdx] === "REP_END") {
            classes.push("rep-end");
        }
        if (rawTokens[nextTokenIdx] === "RDBL" || rawTokens[nextTokenIdx] === "DBL") {
             // ë‹«ëŠ” ê²¹ì„¸ë¡œì¤„ (ë‹¤ìŒ ë§ˆë”” ì‹œì‘ì´ DBLì´ë©´ í˜„ì¬ ë§ˆë”” ëë„ DBL ì²˜ë¦¬)
             classes.push("double-bar");
        }

        // 3. ì•…ìƒê¸°í˜¸ ì¶”ì¶œ
        if (barText.includes("s")) symbols += SVG_SEGNO;
        if (barText.includes("Q")) symbols += SVG_CODA;
        
        // 4. ì§€ì‹œì–´ ì¶”ì¶œ (D.C. al Coda ë“±)
        let instrMatch = barText.match(/(D\.C\.|D\.S\.|Fine).*?(al Coda|al Fine)?/i);
        if (instrMatch) {
            instruction = `<div class="instruction">${instrMatch[0]}</div>`;
            barText = barText.replace(instrMatch[0], "");
        } else if (barText.includes("al Coda")) {
            instruction = `<div class="instruction">al Coda</div>`;
            barText = barText.replace("al Coda", "");
        }

        // 5. ì½”ë“œ ì •ì œ ë° ì¡°ì˜®ê¹€
        let cleanText = barText.replace(/[sSQf]/g, "").replace(/[\{\}]/g, "").trim();
        let displayContent = "";

        if (cleanText === "%") {
            displayContent = `<span class="repeat-symbol">ğ„”</span>`;
        } else if (cleanText === "") {
             displayContent = `&nbsp;`; // ë¹ˆ ë§ˆë”” ìœ ì§€
        } else {
            let transposed = transposeChord(cleanText, transposeSteps);
            displayContent = `<span class="chord">${transposed}</span>`;
        }

        // HTML ì¡°ë¦½
        let style = "";
        html += `<div class="${classes.join(' ')}" style="${style}">`;
        
        if (currentSection) {
            html += `<div class="section">${currentSection}</div>`;
            currentSection = null;
        }
        
        html += symbols;
        html += displayContent;
        html += instruction;
        html += `</div>`;

        barsCount++;
    });
    
    // ì´ ë§ˆë”” ìˆ˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëª‡ ì¤„ì´ í•„ìš”í•œì§€ ê³„ì‚° (ìµœì†Œ 1ì¤„)
    let rowCount = Math.max(1, Math.ceil(barsCount / 4));
    
    // ë‚¨ì€ ì¹¸ ì±„ìš°ê¸° (ë ˆì´ì•„ì›ƒ ê¹¨ì§ ë°©ì§€)
    while (barsCount % 4 !== 0) {
        html += `<div class="cell" style="border-right:none; border-bottom:none;"></div>`;
        barsCount++;
    }

    return { html, rowCount };
}

// ==========================================
// 4. ë©”ì¸ ë¡œì§ (ëª¨ë‹¬ ì²˜ë¦¬ ë³€ê²½)
// ==========================================
async function loadDatabase() {
    try {
        const response = await fetch('jazz_db.json');
        songDatabase = await response.json();
        songDatabase.forEach(s => {
            if(!s.display_chords) s.display_chords = s.chord_string;
        });
        displayResults(songDatabase);
    } catch (e) { document.getElementById('status').innerText = "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨"; }
}

function performSearch() {
    const titleTerm = document.getElementById('titleInput').value.toLowerCase();
    const chordStr = document.getElementById('chordInput').value.trim();
    const mode = document.getElementById('searchMode').value;
    const refKey = document.getElementById('keySelect').value;
    const userChords = chordStr ? chordStr.split(/\s+/).map(parseChord).filter(c => c) : [];
    
    const filtered = songDatabase.filter(song => {
        const titleMatch = song.title.toLowerCase().includes(titleTerm) || song.composer.toLowerCase().includes(titleTerm);
        if (!titleMatch) return false;
        if (userChords.length === 0) return true;
        const songChords = (song.search_chords || []).map(parseChord).filter(c => c);
        if (songChords.length < userChords.length) return false;

        for (let i = 0; i <= songChords.length - userChords.length; i++) {
            let match = true;
            for (let j = 0; j < userChords.length; j++) {
                let s = songChords[i+j];
                let u = userChords[j];
                let qMatch = (s.quality === u.quality) || (s.quality.startsWith("MINOR") && u.quality.startsWith("MINOR"));
                if (!qMatch) { match = false; break; }
                if (mode === 'absolute') { if (getDistance(u.root, s.root) !== 0) { match = false; break; } }
                else if (mode === 'harmonic') { if (getDistance(refKey, u.root) !== getDistance(song.key, s.root)) { match = false; break; } }
                else if (mode === 'relative') { if (getDistance(userChords[0].root, u.root) !== getDistance(songChords[i].root, s.root)) { match = false; break; } }
            }
            if (match) return true;
        }
        return false;
    });
    displayResults(filtered);
}

function displayResults(list) {
    const container = document.getElementById('results');
    container.innerHTML = list.map(s => `
        <div class="p-4 bg-white border border-slate-200 rounded-2xl hover:bg-indigo-50 cursor-pointer transition flex justify-between items-center" 
             onclick="openModal('${s.title.replace(/'/g, "\\'")}')">
            <div><div class="font-bold text-slate-800">${s.title}</div><div class="text-xs text-slate-400">${s.composer}</div></div>
            <div class="text-indigo-300 font-bold">${s.key}</div>
        </div>`).join('');
    document.getElementById('status').innerText = `${list.length}ê³¡ ê²€ìƒ‰ë¨`;
}

function openModal(title) {
    currentOpenedSong = songDatabase.find(s => s.title === title);
    const originalKey = currentOpenedSong.key.replace('-', '');
    const select = document.getElementById('transposeSelect');
    select.innerHTML = allKeys.map(k => `<option value="${k}" ${k === originalKey ? 'selected' : ''}>${k}</option>`).join('');
    
    document.getElementById('mTitle').innerText = currentOpenedSong.title;
    document.getElementById('mComposer').innerText = currentOpenedSong.composer;
    document.getElementById('mStyle').innerText = currentOpenedSong.style || "Jazz";
    document.getElementById('mOriginalKey').innerText = currentOpenedSong.key;

    // ì°¨íŠ¸ ë³´ê¸° ë²„íŠ¼
    const chartContainer = document.getElementById('mChords');
    chartContainer.innerHTML = `
        <div class="text-center py-8 bg-slate-50 rounded-xl border border-dashed border-slate-300 cursor-pointer hover:bg-indigo-50 transition group" onclick="openChartWindow()">
            <div class="text-4xl mb-2 group-hover:scale-110 transition-transform">ğŸ¼</div>
            <div class="text-lg font-bold text-indigo-600 underline">Click to Open Full Chord Chart</div>
            <div class="text-xs text-slate-400 mt-1">(Opens in a new window)</div>
        </div>
    `;
    chartContainer.className = ""; 

    document.getElementById('detailModal').classList.add('active');
    loadLinks(title);
}

async function loadLinks(title) {
    const list = document.getElementById('linkList');
    list.innerHTML = '<div class="text-slate-400 text-sm">ë¡œë”© ì¤‘...</div>';
    try {
        const res = await fetch(`${API_URL}?title=${encodeURIComponent(title)}`);
        const links = await res.json();
        list.innerHTML = links.length ? links.map(l => `
            <li class="bg-white p-3 rounded-xl border border-slate-100 text-sm shadow-sm hover:border-indigo-200 transition">
                <a href="${l.url}" target="_blank" class="block">
                    <div class="flex justify-between items-center mb-1">
                        <div><span class="font-bold text-slate-800 text-base">${l.performer}</span> <span class="text-xs text-slate-400">(${l.year})</span></div>
                        <span class="text-indigo-500 font-bold text-xs">YouTube â†—</span>
                    </div>
                    <div class="text-xs text-slate-500 border-t border-slate-100 pt-1 mt-1">
                        <span class="font-bold text-indigo-400">To.</span> ${l.recommender} <span class="mx-1 text-slate-300">|</span> <span class="italic">"${l.comment}"</span>
                    </div>
                </a>
            </li>`).join('') : '<div class="text-slate-400 text-sm italic">ë“±ë¡ëœ ì—°ì£¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    } catch(e) { list.innerText = 'ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'; }
}

async function addLink() {
    if (isSubmitting) return;
    const btn = document.getElementById('submitBtn');
    const payload = { 
        title: document.getElementById('mTitle').innerText,
        performer: document.getElementById('inPerformer').value.trim(),
        year: document.getElementById('inYear').value.trim(),
        recommender: document.getElementById('inRecommender').value.trim(),
        comment: document.getElementById('inComment').value.trim(),
        url: document.getElementById('inUrl').value.trim() 
    };
    if (!payload.performer || !payload.url) return alert("í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
    isSubmitting = true; btn.innerText = "ë“±ë¡ ì¤‘..."; btn.classList.add('btn-submitting');
    try {
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
        alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!"); loadLinks(payload.title);
        document.getElementById('inPerformer').value = ''; document.getElementById('inYear').value = ''; document.getElementById('inUrl').value = ''; document.getElementById('inRecommender').value = ''; document.getElementById('inComment').value = '';
    } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    finally { isSubmitting = false; btn.innerText = "ë“±ë¡"; btn.classList.remove('btn-submitting'); }
}

function closeModal() { document.getElementById('detailModal').classList.remove('active'); }
document.getElementById('searchMode').addEventListener('change', e => { document.getElementById('keySelect').classList.toggle('hidden', e.target.value !== 'harmonic'); });

loadDatabase();
</script>
</body>
</html>
