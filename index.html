<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jazz Standard Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; }
        .modal.active { display: flex; }
        .chord-font { font-family: 'Courier New', monospace; font-weight: bold; }
        .highlight { 
            background-color: #fbbf24; color: #000; padding: 2px 4px; 
            border-radius: 4px; font-weight: 900; box-shadow: 0 0 5px rgba(251, 191, 36, 0.8);
        }
        .btn-submitting { opacity: 0.5; cursor: not-allowed; pointer-events: none; background-color: #64748b !important; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4">

<div class="max-w-3xl mx-auto bg-white shadow-2xl rounded-3xl p-6 md:p-10">
    <h1 class="text-3xl font-black text-indigo-700 text-center mb-6">ğŸ· Jazz Archive Search</h1>

    <div class="space-y-4 bg-slate-50 p-6 rounded-2xl border border-slate-200 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ì œëª©/ì‘ê³¡ê°€ ê²€ìƒ‰</label>
                <input type="text" id="titleInput" placeholder="ê³¡ ì œëª©..." class="w-full p-3 rounded-xl border border-slate-300 outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ê²€ìƒ‰ ëª¨ë“œ</label>
                <select id="searchMode" class="w-full p-3 rounded-xl border border-slate-300 bg-white">
                    <option value="absolute">ì‹¤ìŒ ì½”ë“œ (Real Note)</option>
                    <option value="harmonic">í™”ì„±ì  ê¸°ëŠ¥ (Harmonic Function)</option>
                    <option value="relative" selected>ìƒëŒ€ì  ì¸í„°ë²Œ (Interval)</option>
                </select>
            </div>
        </div>
        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ì½”ë“œ ì§„í–‰ ì…ë ¥ (Bass í¬í•¨ ê°€ëŠ¥)</label>
            <div class="flex gap-2">
                <input type="text" id="chordInput" placeholder="Am7 D7 Gmaj7" class="flex-1 p-3 rounded-xl border border-slate-300 outline-none focus:ring-2 focus:ring-indigo-500">
                <select id="keySelect" class="p-3 rounded-xl border border-slate-300 bg-white hidden">
                    <option value="C">C</option><option value="Db">Db</option><option value="D">D</option><option value="Eb">Eb</option><option value="E">E</option><option value="F">F</option><option value="Gb">Gb</option><option value="G">G</option><option value="Ab">Ab</option><option value="A">A</option><option value="Bb">Bb</option><option value="B">B</option>
                </select>
                <button onclick="performSearch()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 transition">ê²€ìƒ‰</button>
            </div>
        </div>
    </div>

    <div id="status" class="text-sm text-center text-slate-400 mb-4 italic">ë°ì´í„° ë¡œë“œ ì¤‘...</div>
    <div id="results" class="grid grid-cols-1 gap-2"></div>
</div>

<div id="detailModal" class="modal items-center justify-center">
    <div class="bg-white w-full max-w-lg m-4 p-8 rounded-3xl shadow-2xl relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeModal()" class="absolute top-6 right-6 text-slate-300 hover:text-slate-600 text-2xl">âœ•</button>
        <h2 id="mTitle" class="text-3xl font-black text-slate-800 mb-1"></h2>
        <p id="mInfo" class="text-indigo-500 font-bold mb-6"></p>
        <div class="bg-indigo-50 p-5 rounded-2xl mb-8">
            <h3 class="text-xs font-black text-indigo-300 uppercase mb-2">Chords</h3>
            <div id="mChords" class="chord-font text-lg text-indigo-900 break-all leading-relaxed"></div>
        </div>
        <div class="mb-8">
            <h3 class="text-lg font-bold text-slate-800 mb-4">ğŸ¥ ì¶”ì²œ ì—°ì£¼</h3>
            <ul id="linkList" class="space-y-3"></ul>
        </div>
        <div class="bg-slate-50 p-6 rounded-2xl border border-dashed border-slate-300">
            <h4 class="text-sm font-bold text-slate-600 mb-3">ì—°ì£¼ ë§í¬ ë“±ë¡</h4>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <input id="inPerformer" type="text" placeholder="ì—°ì£¼ì" class="p-2 rounded-lg border text-sm">
                <input id="inYear" type="text" placeholder="ì—°ë„" class="p-2 rounded-lg border text-sm">
            </div>
            <input id="inUrl" type="text" placeholder="YouTube URL" class="w-full p-2 rounded-lg border text-sm mb-3">
            <button id="submitBtn" onclick="addLink()" class="w-full bg-slate-800 text-white py-2 rounded-lg font-bold">ë“±ë¡</button>
        </div>
    </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyKW8Ru9l1wbFqWEI70Nd8ZuBn8QR7YAVKTem1xY_tyIG8JkzifEUn0-4ndFvbxr1FSsg/exec";
let songDatabase = [];
let isSubmitting = false;

// --- íŒŒì´ì¬ HarmonyEngine ë¡œì§ ì´ì‹ ---
const noteMap = {'C':0,'B#':0,'Db':1,'C#':1,'D':2,'Eb':3,'D#':3,'E':4,'Fb':4,'F':5,'E#':5,'Gb':6,'F#':6,'G':7,'Ab':8,'G#':8,'A':9,'Bb':10,'A#':10,'B':11,'Cb':11};

function simplifyQuality(q) {
    q = q.trim().replace(/\^/g, "maj").replace(/min/g, "m").replace(/Min/g, "m");
    if (q.includes("m7b5") || q.includes("h") || q.includes("Ã¸")) return "HALF_DIM";
    if (q.includes("dim") || q.includes("o") || q.includes("Â°")) return "DIM";
    if (/[79]|11|13|alt/.test(q)) {
        let isMinor = q.includes("m") || (q.includes("-") && !q.includes("7-"));
        let isMajor = q.includes("maj") || q.includes("M");
        if (!isMinor && !isMajor) return "DOMINANT";
        if (q.includes("7-")) return "DOMINANT";
    }
    if (q.includes("m") || q.includes("-")) return "MINOR";
    if (q === "" || q === "6" || q.includes("maj") || q.includes("M")) return "MAJOR";
    return "DOMINANT";
}

function parseChord(str) {
    if (!str || str.startsWith('*') || str.startsWith('T')) return null;
    let [main, bass] = str.split('/');
    if (!main || !/^[A-G]/.test(main)) return null;
    
    let match = main.match(/^([A-G][b#]?)(.*)/);
    if (!match) return null;
    
    let root = match[1];
    let quality = simplifyQuality(match[2]);
    let finalBass = bass || root;
    return { root, quality, bass: finalBass };
}

function getSemitoneDistance(n1, n2) {
    // iReal Key í‘œê¸°ë²• ì •ê·œí™” (A- -> A)
    const r1 = n1.replace('-', '').trim();
    const r2 = n2.replace('-', '').trim();
    if (!(r1 in noteMap) || !(r2 in noteMap)) return 0;
    return (noteMap[r2] - noteMap[r1] + 12) % 12;
}

// --- ë°ì´í„° ê²€ìƒ‰ ì—”ì§„ ---
async function loadDatabase() {
    try {
        const response = await fetch('jazz_db.json');
        const data = await response.json();
        // JSON ë°ì´í„° êµ¬ì¡°ì— ë”°ë¼ search_chordsê°€ ì—†ìœ¼ë©´ ì‹¤ì‹œê°„ ìƒì„±
        songDatabase = data.map(s => ({
            ...s,
            parsedChords: (s.search_chords || s.chord_string.replace(/(\*[A-Z]|T\d+|[\[\]\{\}\(\)<>xWn|])/g, " ").split(/\s+/))
                           .filter(c => c && !/^\d+$/.test(c))
        }));
        displayResults(songDatabase);
    } catch (e) { document.getElementById('status').innerText = "JSON ë¡œë“œ ì‹¤íŒ¨"; }
}

function performSearch() {
    const titleTerm = document.getElementById('titleInput').value.toLowerCase();
    const chordStr = document.getElementById('chordInput').value.trim();
    const mode = document.getElementById('searchMode').value;
    const refKey = document.getElementById('keySelect').value;
    
    const userChords = chordStr ? chordStr.split(/\s+/).map(parseChord).filter(c => c) : [];
    
    const filtered = songDatabase.filter(song => {
        const titleMatch = song.title.toLowerCase().includes(titleTerm) || song.composer.toLowerCase().includes(titleTerm);
        if (!titleMatch) return false;
        if (userChords.length === 0) return true;

        const songChords = song.parsedChords.map(parseChord).filter(c => c);
        if (songChords.length < userChords.length) return false;

        for (let i = 0; i <= songChords.length - userChords.length; i++) {
            let match = true;
            for (let j = 0; j < userChords.length; j++) {
                let s = songChords[i+j];
                let u = userChords[j];
                
                if (s.quality !== u.quality) { match = false; break; }

                if (mode === 'absolute') {
                    if (getSemitoneDistance(u.root, s.root) !== 0) { match = false; break; }
                    if (getSemitoneDistance(u.bass, s.bass) !== 0) { match = false; break; }
                } else if (mode === 'harmonic') {
                    if (getSemitoneDistance(refKey, u.root) !== getSemitoneDistance(song.key, s.root)) { match = false; break; }
                    if (getSemitoneDistance(u.root, u.bass) !== getSemitoneDistance(s.root, s.bass)) { match = false; break; }
                } else if (mode === 'relative') {
                    if (getSemitoneDistance(userChords[0].root, u.root) !== getSemitoneDistance(songChords[i].root, s.root)) { match = false; break; }
                    if (getSemitoneDistance(u.root, u.bass) !== getSemitoneDistance(s.root, s.bass)) { match = false; break; }
                }
            }
            if (match) return true;
        }
        return false;
    });
    displayResults(filtered);
}

// --- UI ë° ëª¨ë‹¬ ë¡œì§ ---
function displayResults(list) {
    const container = document.getElementById('results');
    container.innerHTML = list.map(s => `
        <div class="p-4 bg-white border border-slate-200 rounded-2xl hover:bg-indigo-50 cursor-pointer transition flex justify-between items-center" 
             onclick="openModal('${s.title.replace(/'/g, "\\'")}')">
            <div><div class="font-bold text-slate-800">${s.title}</div><div class="text-xs text-slate-400">${s.composer}</div></div>
            <div class="text-indigo-300 font-bold">${s.key}</div>
        </div>
    `).join('');
    document.getElementById('status').innerText = `${list.length}ê³¡ ê²€ìƒ‰ë¨`;
}

async function openModal(title) {
    const song = songDatabase.find(s => s.title === title);
    const searchInput = document.getElementById('chordInput').value.trim();
    document.getElementById('mTitle').innerText = song.title;
    document.getElementById('mInfo').innerText = `${song.composer} | Key: ${song.key}`;
    
    let displayHtml = (song.display_chords || song.parsedChords.join(' '));
    if (searchInput) {
        searchInput.split(/\s+/).forEach(t => {
            const regex = new RegExp(`\\b${t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'g');
            displayHtml = displayHtml.replace(regex, `<span class="highlight">${t}</span>`);
        });
    }
    document.getElementById('mChords').innerHTML = displayHtml;
    document.getElementById('detailModal').classList.add('active');
    
    // ë§í¬ ë¡œë“œ
    document.getElementById('linkList').innerHTML = 'Loading...';
    try {
        const res = await fetch(`${API_URL}?title=${encodeURIComponent(title)}`);
        const links = await res.json();
        document.getElementById('linkList').innerHTML = links.map(l => `<li class="bg-white p-3 rounded-xl border border-slate-100 text-sm"><a href="${l.url}" target="_blank" class="flex justify-between"><span><b>${l.performer}</b> (${l.year})</span><span class="text-indigo-500">YouTube â†—</span></a></li>`).join('') || 'No links yet.';
    } catch(e) { document.getElementById('linkList').innerHTML = 'Error loading links.'; }
}

async function addLink() {
    if (isSubmitting) return;
    const btn = document.getElementById('submitBtn');
    const payload = { 
        title: document.getElementById('mTitle').innerText,
        performer: document.getElementById('inPerformer').value.trim(),
        year: document.getElementById('inYear').value.trim(),
        url: document.getElementById('inUrl').value.trim() 
    };
    if (!payload.performer || !payload.url) return alert("ì…ë ¥ë€ì„ ì±„ì›Œì£¼ì„¸ìš”.");

    isSubmitting = true;
    btn.innerText = "ë“±ë¡ ì¤‘...";
    btn.classList.add('btn-submitting');

    try {
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
        alert("ë“±ë¡ ì„±ê³µ!");
        openModal(payload.title);
    } catch(e) { alert("ë“±ë¡ ì˜¤ë¥˜"); }
    finally { isSubmitting = false; btn.innerText = "ë“±ë¡"; btn.classList.remove('btn-submitting'); }
}

function closeModal() { document.getElementById('detailModal').classList.remove('active'); }
document.getElementById('searchMode').addEventListener('change', e => document.getElementById('keySelect').classList.toggle('hidden', e.target.value !== 'harmonic'));

loadDatabase();
</script>
</body>
</html>
