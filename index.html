<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jazz Standard Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ì•…ë³´ ìŠ¤íƒ€ì¼ ì •ì˜ */
        .sheet-music-container {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #fff;
            color: #1a1a1a;
        }
        .chord-chart {
            font-family: 'Courier New', monospace;
            font-size: 1.15rem; 
            line-height: 2.8; 
            white-space: pre; 
            overflow-x: auto;
            font-weight: bold;
            color: #1e3a8a;
        }
        .section-marker {
            color: #dc2626; /* ë¹¨ê°„ìƒ‰ ì„¹ì…˜ (A, B) */
            font-weight: 900;
            font-size: 1.3em;
            display: block; /* ì„¹ì…˜ ë‚˜ì˜¤ë©´ ì¤„ë°”ê¿ˆ */
            margin-top: 24px;
            margin-bottom: 4px;
        }
        .bar-line {
            color: #94a3b8;
            font-weight: normal;
            margin: 0 4px;
        }
        .time-sig {
            font-size: 0.7em;
            color: #64748b;
            vertical-align: super;
            margin-right: 4px;
            font-style: italic;
        }
        .highlight {
            background-color: #fde047; /* ë…¸ë€ìƒ‰ í•˜ì´ë¼ì´íŠ¸ */
            color: #000;
            padding: 4px 0;
            border-radius: 2px;
            box-shadow: 0 0 4px #fde047;
        }
        .btn-submitting { opacity: 0.5; cursor: not-allowed; pointer-events: none; background-color: #64748b !important; }
        
        /* ëª¨ë‹¬ í˜ì´ë“œ íš¨ê³¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; opacity: 0; transition: opacity 0.3s; }
        .modal.active { display: flex; opacity: 1; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4">

<div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-3xl p-6 md:p-10">
    <h1 class="text-3xl font-black text-indigo-700 text-center mb-6">ğŸ· Jazz Archive Search</h1>

    <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200 mb-8 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ì œëª©/ì‘ê³¡ê°€</label>
                <input type="text" id="titleInput" placeholder="ê³¡ ì œëª©..." class="w-full p-3 rounded-xl border border-slate-300 outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ê²€ìƒ‰ ëª¨ë“œ</label>
                <select id="searchMode" class="w-full p-3 rounded-xl border border-slate-300 bg-white">
                    <option value="relative" selected>ìƒëŒ€ì  ì¸í„°ë²Œ (Relative Interval)</option>
                    <option value="harmonic">í™”ì„±ì  ê¸°ëŠ¥ (Harmonic Function)</option>
                    <option value="absolute">ì‹¤ìŒ ì½”ë“œ (Real Note)</option>
                </select>
            </div>
        </div>
        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ì½”ë“œ ì§„í–‰ (ì˜ˆ: Am7 D7 Gmaj7)</label>
            <div class="flex gap-2">
                <input type="text" id="chordInput" placeholder="ì½”ë“œ ì…ë ¥..." class="flex-1 p-3 rounded-xl border border-slate-300 outline-none focus:ring-2 focus:ring-indigo-500">
                <select id="keySelect" class="p-3 rounded-xl border border-slate-300 bg-white hidden">
                    <option value="C">C</option><option value="Db">Db</option><option value="D">D</option><option value="Eb">Eb</option><option value="E">E</option><option value="F">F</option><option value="Gb">Gb</option><option value="G">G</option><option value="Ab">Ab</option><option value="A">A</option><option value="Bb">Bb</option><option value="B">B</option>
                </select>
                <button onclick="performSearch()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 transition">ê²€ìƒ‰</button>
            </div>
        </div>
    </div>

    <div id="status" class="text-sm text-center text-slate-400 mb-4 italic">ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ ì¤‘...</div>
    <div id="results" class="grid grid-cols-1 gap-2"></div>
</div>

<div id="detailModal" class="modal items-center justify-center">
    <div class="bg-white w-full max-w-2xl m-2 p-8 rounded-sm shadow-2xl relative max-h-[95vh] overflow-y-auto sheet-music-container">
        <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-black text-3xl transition">âœ•</button>
        
        <div class="border-b-2 border-black pb-4 mb-6 text-center relative mt-4">
            <div id="mStyle" class="absolute left-0 top-1 text-xs font-bold uppercase text-slate-500 tracking-widest hidden md:block"></div>
            <h2 id="mTitle" class="text-3xl md:text-4xl font-serif font-bold tracking-tight uppercase"></h2>
            <div id="mComposer" class="absolute right-0 top-1 text-sm font-medium italic hidden md:block"></div>
        </div>

        <div class="flex justify-between items-end mb-4">
            <div class="text-sm text-slate-500">Original Key: <span id="mOriginalKey" class="font-bold text-black"></span></div>
            <div class="flex flex-col items-end">
                <label class="text-[10px] font-bold text-slate-400 uppercase">TRANSPOSE</label>
                <select id="transposeSelect" onchange="updateModalDisplay()" class="text-lg font-bold border-b-2 border-black bg-transparent outline-none cursor-pointer"></select>
            </div>
        </div>

        <div class="bg-white p-4 md:p-8 border border-slate-100 shadow-inner rounded-lg mb-8 overflow-hidden">
            <div id="mChords" class="chord-chart"></div>
        </div>

        <div class="mt-8 pt-6 border-t border-slate-100">
            <h3 class="text-lg font-black mb-4 flex items-center gap-2 text-slate-800">ğŸ¥ Recommended Performances</h3>
            <ul id="linkList" class="grid grid-cols-1 gap-2 mb-6"></ul>
            
            <div class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">Add Performance Link</h4>
                <div class="grid grid-cols-3 gap-2 mb-2">
                    <input id="inPerformer" type="text" placeholder="Artist" class="col-span-2 p-2 rounded border text-sm">
                    <input id="inYear" type="text" placeholder="Year" class="p-2 rounded border text-sm">
                </div>
                <input id="inUrl" type="text" placeholder="YouTube URL" class="w-full p-2 rounded border text-sm mb-3">
                <button id="submitBtn" onclick="addLink()" class="w-full bg-slate-800 text-white py-2 rounded font-bold hover:bg-black transition">Submit Link</button>
            </div>
        </div>
    </div>
</div>

<script>
// ==========================================
// 1. ì„¤ì • ë° ì „ì—­ ë³€ìˆ˜
// ==========================================
const API_URL = "https://script.google.com/macros/s/AKfycbyKW8Ru9l1wbFqWEI70Nd8ZuBn8QR7YAVKTem1xY_tyIG8JkzifEUn0-4ndFvbxr1FSsg/exec";
let songDatabase = [];
let currentOpenedSong = null;
let isSubmitting = false;

const allKeys = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
const noteMap = {'C':0,'B#':0,'Db':1,'C#':1,'D':2,'Eb':3,'D#':3,'E':4,'Fb':4,'F':5,'E#':5,'Gb':6,'F#':6,'G':7,'Ab':8,'G#':8,'A':9,'Bb':10,'A#':10,'B':11,'Cb':11};

// ==========================================
// 2. í™”ì„±í•™ ì—”ì§„ (ê²€ìƒ‰ ë° ì¡°ì˜®ê¹€)
// ==========================================
function simplifyQuality(q) {
    q = q.trim().replace(/\^/g, "maj").replace(/min/g, "m").replace(/Min/g, "m");
    if (q.includes("m7b5") || q.includes("h") || q.includes("Ã¸")) return "HALF_DIM";
    if (q.includes("dim") || q.includes("o") || q.includes("Â°")) return "DIM";
    if (/[79]|11|13|alt/.test(q)) {
        let isMinor = q.includes("m") || (q.includes("-") && !q.includes("7-"));
        let isMajor = q.includes("maj") || q.includes("M");
        if (!isMinor && !isMajor) return "DOMINANT";
        if (q.includes("7-")) return "DOMINANT";
    }
    if (q.includes("m") || q.includes("-")) return "MINOR";
    if (q === "" || q === "6" || q.includes("maj") || q.includes("M")) return "MAJOR";
    return "DOMINANT";
}

function parseChord(str) {
    if (!str) return null;
    let [main, bass] = str.split('/');
    let match = main.match(/^([A-G][b#]?)(.*)/);
    if (!match) return null;
    return { root: match[1], quality: simplifyQuality(match[2]), bass: bass || match[1] };
}

function getDistance(n1, n2) {
    const r1 = n1.replace('-', '').trim();
    const r2 = n2.replace('-', '').trim();
    if (!(r1 in noteMap) || !(r2 in noteMap)) return 0;
    return (noteMap[r2] - noteMap[r1] + 12) % 12;
}

function transposeChord(chord, steps) {
    // ì½”ë“œ í…ìŠ¤íŠ¸ ë‚´ì˜ ëª¨ë“  ê·¼ìŒ(Root)ê³¼ ë² ì´ìŠ¤(Bass)ë¥¼ ì°¾ì•„ ë³€í™˜
    return chord.replace(/([A-G][b#]?)/g, (match) => {
        // ì´ë¯¸ ì²˜ë¦¬ëœ í…ìŠ¤íŠ¸ê°€ ê²¹ì¹˜ì§€ ì•Šê²Œ ì£¼ì˜í•´ì•¼ í•˜ì§€ë§Œ, A-G íŒ¨í„´ì€ ì•ˆì „í•¨
        const idx = allKeys.indexOf(match.replace('C#','Db').replace('D#','Eb').replace('F#','Gb').replace('G#','Ab').replace('A#','Bb').replace('B#','C').replace('Cb','B'));
        if (idx === -1) return match;
        const newIdx = (idx + steps + 12) % 12;
        return allKeys[newIdx];
    });
}

// ==========================================
// 3. 4ë§ˆë”” ê³ ì • ë° ì•…ë³´ ë Œë”ë§ ì—”ì§„ (í•µì‹¬)
// ==========================================
function formatTo4BarGrid(rawString, transposeSteps, searchInput) {
    // [Step 1] ì „ì²˜ë¦¬: íŒŒì‹±í•˜ê¸° ì‰½ê²Œ í† í°í™”
    let text = rawString
        .replace(/\*([a-zA-Z])/g, "||SECTION_$1||") // ì„¹ì…˜
        .replace(/T(\d)(\d)/g, "||TIME_$1/$2||")    // ë°•ìí‘œ
        .replace(/x/g, " % ")                       // ë°˜ë³µê¸°í˜¸
        .replace(/[\[\]\{\}]/g, "|")                // ê´„í˜¸ë¥¼ ë§ˆë””ì„ ìœ¼ë¡œ
        .replace(/\|+/g, "|");                      // ì¤‘ë³µ ë§ˆë””ì„  ì œê±°

    // [Step 2] ë§ˆë”” ë‹¨ìœ„ ë¶„ë¦¬
    let rawBars = text.split('|').map(b => b.trim()).filter(b => b.length > 0);

    let htmlOutput = "";
    let barCount = 0;

    // [Step 3] ê²€ìƒ‰ì–´ ì „ì²˜ë¦¬ (í•˜ì´ë¼ì´íŠ¸ìš©)
    // ê²€ìƒ‰ì–´ë„ í˜„ì¬ í‚¤ì— ë§ê²Œ ì¡°ì˜®ê¹€í•´ì•¼ ì •í™•í•œ í•˜ì´ë¼ì´íŠ¸ê°€ ê°€ëŠ¥í•˜ì§€ë§Œ,
    // ë³µì¡ì„±ì„ ì¤„ì´ê¸° ìœ„í•´ ì—¬ê¸°ì„œëŠ” 'ì‚¬ìš©ìê°€ ì…ë ¥í•œ í…ìŠ¤íŠ¸'ê°€ 'ì¡°ì˜®ê¹€ëœ ê²°ê³¼'ì— ìˆì„ ë•Œ í•˜ì´ë¼ì´íŠ¸í•©ë‹ˆë‹¤.
    // ë§Œì•½ "Dm7 G7"ì„ ê²€ìƒ‰í–ˆê³ , Cí‚¤ë¡œ ì¡°ì˜®ê¹€ë˜ì–´ "Am7 D7"ì´ ë˜ì—ˆë‹¤ë©´, 
    // ê²€ìƒ‰ì–´ ìì²´ë„ ë‚´ë¶€ì ìœ¼ë¡œ ì¡°ì˜®ê¹€í•´ì„œ ë¹„êµí•˜ëŠ” ê²ƒì´ ê°€ì¥ ì •í™•í•©ë‹ˆë‹¤.
    // ì´ë²ˆ ë²„ì „ì—ì„œëŠ” 'ì¡°ì˜®ê¹€ëœ ê²€ìƒ‰ì–´'ë¥¼ ìƒì„±í•˜ì—¬ ë§¤ì¹­í•©ë‹ˆë‹¤.
    
    let targetSequence = "";
    if (searchInput) {
        // ê²€ìƒ‰ì–´ë„ ë˜‘ê°™ì´ ì¡°ì˜®ê¹€
        targetSequence = transposeChord(searchInput, transposeSteps);
    }

    // ë§ˆë”” ì¡°ë¦½ ë£¨í”„
    for (let i = 0; i < rawBars.length; i++) {
        let bar = rawBars[i];

        // ë©”íƒ€ ë°ì´í„° ì²˜ë¦¬
        if (bar.startsWith("SECTION_")) {
            if (barCount > 0) htmlOutput += "\n"; 
            htmlOutput += `<span class="section-marker">[${bar.split('_')[1]}]</span>`;
            barCount = 0;
            continue;
        }
        if (bar.startsWith("TIME_")) {
            htmlOutput += `<span class="time-sig">(${bar.split('_')[1]})</span>`;
            continue;
        }

        // ì½”ë“œ ì¡°ì˜®ê¹€
        let transposedBar = transposeChord(bar, transposeSteps);
        
        // ë§ˆë”” ë””ìì¸ (ê³µë°± íŒ¨ë”©ìœ¼ë¡œ ë„ˆë¹„ ë§ì¶¤ - íƒ­ ë¬¸ì ëŒ€ì‹  ìŠ¤í˜ì´ìŠ¤ ì‚¬ìš©)
        // ì½”ë“œê°€ ì§§ìœ¼ë©´ ë’¤ì— ê³µë°±ì„ ì±„ì›Œ ì‹œê°ì  ê· í˜•ì„ ë§ì¶¤
        let paddedBar = transposedBar + " ".repeat(Math.max(0, 10 - transposedBar.length));

        // í•˜ì´ë¼ì´íŠ¸ (ì¡°ì˜®ê¹€ëœ ê²€ìƒ‰ì–´ì™€ ë¹„êµ)
        // ë¶€ë¶„ ë§¤ì¹­ì´ ì•„ë‹ˆë¼ ì‹œí€€ìŠ¤ ë§¤ì¹­ì„ ìœ„í•´ ë§ˆë””ë³„ë¡œ ì²´í¬í•˜ê¸°ë³´ë‹¤
        // ì „ì²´ ë¬¸ìì—´ ìƒì„± í›„ ë§ˆì§€ë§‰ì— replaceí•˜ëŠ” ê²ƒì´ ì‹œí€€ìŠ¤(ì—¬ëŸ¬ ë§ˆë”” ê±¸ì¹œ ì½”ë“œ) ë§¤ì¹­ì— ìœ ë¦¬í•  ìˆ˜ ìˆìŒ.
        // í•˜ì§€ë§Œ 4ë§ˆë”” ê·¸ë¦¬ë“œ êµ¬ì¡°ìƒ íƒœê·¸ê°€ ì„ì´ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” 'ì½”ë“œ ë‹¨ìœ„' ë§¤ì¹­ì„ ì‹œë„í•©ë‹ˆë‹¤.
        if (targetSequence) {
             const tokens = targetSequence.split(/\s+/);
             tokens.forEach(token => {
                 // ë‹¨ì–´ ê²½ê³„(\b)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì •í™•í•œ ë§¤ì¹­ (ì˜ˆ: Cê°€ Cmë¥¼ ì¡ì§€ ì•Šê²Œ)
                 const regex = new RegExp(`\\b${token.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'g');
                 paddedBar = paddedBar.replace(regex, '<span class="highlight">$&</span>');
             });
        }

        // ì¶œë ¥
        if (barCount === 0) htmlOutput += "<span class='bar-line'>|</span>";
        htmlOutput += ` ${paddedBar}<span class='bar-line'>|</span>`;
        barCount++;

        if (barCount === 4) {
            htmlOutput += "\n";
            barCount = 0;
        }
    }
    
    return htmlOutput;
}

// ==========================================
// 4. ë©”ì¸ ë¡œì§ (ê²€ìƒ‰, ëª¨ë‹¬ ë“±)
// ==========================================
async function loadDatabase() {
    try {
        const response = await fetch('jazz_db.json');
        songDatabase = await response.json();
        // display_chordsê°€ ì—†ëŠ” êµ¬í˜• ë°ì´í„° í˜¸í™˜ì„± ì²˜ë¦¬
        songDatabase.forEach(s => {
            if(!s.search_chords) s.search_chords = s.chord_string.split(" ");
            if(!s.display_chords) s.display_chords = s.chord_string;
        });
        displayResults(songDatabase);
    } catch (e) { document.getElementById('status').innerText = "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨"; }
}

function performSearch() {
    const titleTerm = document.getElementById('titleInput').value.toLowerCase();
    const chordStr = document.getElementById('chordInput').value.trim();
    const mode = document.getElementById('searchMode').value;
    const refKey = document.getElementById('keySelect').value;
    
    const userChords = chordStr ? chordStr.split(/\s+/).map(parseChord).filter(c => c) : [];
    
    const filtered = songDatabase.filter(song => {
        const titleMatch = song.title.toLowerCase().includes(titleTerm) || song.composer.toLowerCase().includes(titleTerm);
        if (!titleMatch) return false;
        if (userChords.length === 0) return true;

        // ê²€ìƒ‰ì€ 'search_chords' (ìˆœìˆ˜ ì½”ë“œ ë¦¬ìŠ¤íŠ¸) ì‚¬ìš©
        const songChords = song.search_chords.map(parseChord).filter(c => c);
        if (songChords.length < userChords.length) return false;

        for (let i = 0; i <= songChords.length - userChords.length; i++) {
            let match = true;
            for (let j = 0; j < userChords.length; j++) {
                let s = songChords[i+j];
                let u = userChords[j];
                
                // Quality Check (Minor vs Minor7 í˜¸í™˜)
                let qMatch = (s.quality === u.quality) || (s.quality.startsWith("MINOR") && u.quality.startsWith("MINOR"));
                if (!qMatch) { match = false; break; }

                if (mode === 'absolute') {
                    if (getDistance(u.root, s.root) !== 0) { match = false; break; }
                } else if (mode === 'harmonic') {
                    if (getDistance(refKey, u.root) !== getDistance(song.key, s.root)) { match = false; break; }
                } else if (mode === 'relative') {
                    if (getDistance(userChords[0].root, u.root) !== getDistance(songChords[i].root, s.root)) { match = false; break; }
                }
            }
            if (match) return true;
        }
        return false;
    });

    displayResults(filtered);
}

function displayResults(list) {
    const container = document.getElementById('results');
    container.innerHTML = list.map(s => `
        <div class="p-4 bg-white border border-slate-200 rounded-2xl hover:bg-indigo-50 cursor-pointer transition flex justify-between items-center" 
             onclick="openModal('${s.title.replace(/'/g, "\\'")}')">
            <div>
                <div class="font-bold text-slate-800">${s.title}</div>
                <div class="text-xs text-slate-400">${s.composer}</div>
            </div>
            <div class="text-indigo-300 font-bold">${s.key}</div>
        </div>
    `).join('');
    document.getElementById('status').innerText = `${list.length}ê³¡ ê²€ìƒ‰ë¨`;
}

// ëª¨ë‹¬ ì—´ê¸°
function openModal(title) {
    currentOpenedSong = songDatabase.find(s => s.title === title);
    const originalKey = currentOpenedSong.key.replace('-', '');
    
    // í‚¤ ì„ íƒ ë°•ìŠ¤ ì´ˆê¸°í™”
    const select = document.getElementById('transposeSelect');
    select.innerHTML = allKeys.map(k => `<option value="${k}" ${k === originalKey ? 'selected' : ''}>${k}</option>`).join('');
    
    // ë©”íƒ€ ì •ë³´ ë°”ì¸ë”©
    document.getElementById('mTitle').innerText = currentOpenedSong.title;
    document.getElementById('mComposer').innerText = currentOpenedSong.composer;
    document.getElementById('mStyle').innerText = currentOpenedSong.style || "Jazz";
    document.getElementById('mOriginalKey').innerText = currentOpenedSong.key;

    // í™”ë©´ ê·¸ë¦¬ê¸°
    updateModalDisplay();
    document.getElementById('detailModal').classList.add('active');
    
    // ìœ íŠœë¸Œ ë§í¬ ë¡œë“œ
    loadLinks(title);
}

// í™”ë©´ ì—…ë°ì´íŠ¸ (ì¡°ì˜®ê¹€ ì‹œ í˜¸ì¶œ)
function updateModalDisplay() {
    if (!currentOpenedSong) return;
    
    const targetKey = document.getElementById('transposeSelect').value;
    const originalKey = currentOpenedSong.key.replace('-', '');
    const steps = (allKeys.indexOf(targetKey) - allKeys.indexOf(originalKey) + 12) % 12;
    const searchInput = document.getElementById('chordInput').value.trim();

    // 4ë§ˆë”” ê·¸ë¦¬ë“œ í¬ë§·íŒ… ì‹¤í–‰
    const finalHtml = formatTo4BarGrid(currentOpenedSong.display_chords, steps, searchInput);
    document.getElementById('mChords').innerHTML = finalHtml;
}

// ìœ íŠœë¸Œ ë§í¬ ë¡œë“œ
async function loadLinks(title) {
    const list = document.getElementById('linkList');
    list.innerHTML = '<div class="text-slate-400 text-sm">ë¡œë”© ì¤‘...</div>';
    try {
        const res = await fetch(`${API_URL}?title=${encodeURIComponent(title)}`);
        const links = await res.json();
        list.innerHTML = links.length ? links.map(l => `
            <li class="bg-white p-3 rounded-xl border border-slate-100 text-sm shadow-sm hover:border-indigo-200 transition">
                <a href="${l.url}" target="_blank" class="flex justify-between items-center">
                    <div><span class="font-bold text-slate-700">${l.performer}</span> <span class="text-xs text-slate-400">(${l.year})</span></div>
                    <span class="text-indigo-500 font-bold text-xs">YouTube â†—</span>
                </a>
            </li>`).join('') : '<div class="text-slate-400 text-sm italic">ë“±ë¡ëœ ì—°ì£¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    } catch(e) { list.innerText = 'ì—°ì£¼ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'; }
}

// ë§í¬ ë“±ë¡ (ì¤‘ë³µ ë°©ì§€)
async function addLink() {
    if (isSubmitting) return;
    const btn = document.getElementById('submitBtn');
    const payload = { 
        title: document.getElementById('mTitle').innerText,
        performer: document.getElementById('inPerformer').value.trim(),
        year: document.getElementById('inYear').value.trim(),
        url: document.getElementById('inUrl').value.trim() 
    };
    
    if (!payload.performer || !payload.url) return alert("ì—°ì£¼ìì™€ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    isSubmitting = true;
    btn.innerText = "ë“±ë¡ ì¤‘...";
    btn.classList.add('btn-submitting');

    try {
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
        alert("ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
        loadLinks(payload.title); // ëª©ë¡ ê°±ì‹ 
        document.getElementById('inPerformer').value = '';
        document.getElementById('inYear').value = '';
        document.getElementById('inUrl').value = '';
    } catch(e) { alert("ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
    finally { isSubmitting = false; btn.innerText = "ë“±ë¡"; btn.classList.remove('btn-submitting'); }
}

function closeModal() { document.getElementById('detailModal').classList.remove('active'); }

// ê²€ìƒ‰ ëª¨ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
document.getElementById('searchMode').addEventListener('change', e => {
    document.getElementById('keySelect').classList.toggle('hidden', e.target.value !== 'harmonic');
});

// ì‹œì‘
loadDatabase();
</script>
</body>
</html>
